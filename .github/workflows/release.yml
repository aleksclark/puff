name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (leave empty for auto CALVER)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.3'
        cache: true

    - name: Run tests
      run: |
        go test -v ./pkg/...
        go test -v ./test/...

    - name: Generate CALVER version
      id: calver
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          # Generate CALVER: YYYY.0M.0D
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          DAY=$(date +%d)

          # Check if a release already exists for today
          BASE_VERSION="${YEAR}.${MONTH}.${DAY}"
          MICRO=0

          # Query existing releases to find if we need a micro version
          EXISTING_RELEASES=$(gh release list --limit 100 --json tagName --jq '.[].tagName' || echo "")

          while echo "$EXISTING_RELEASES" | grep -q "^v${BASE_VERSION}"; do
            if [ $MICRO -eq 0 ]; then
              VERSION="${BASE_VERSION}.1"
              MICRO=1
            else
              MICRO=$((MICRO + 1))
              VERSION="${BASE_VERSION}.${MICRO}"
            fi

            # Break if version doesn't exist
            if ! echo "$EXISTING_RELEASES" | grep -q "^v${VERSION}"; then
              break
            fi
          done

          if [ $MICRO -eq 0 ]; then
            VERSION=$BASE_VERSION
          fi
        fi

        # Ensure version starts with 'v'
        if [[ $VERSION != v* ]]; then
          VERSION="v${VERSION}"
        fi

        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build binaries
      run: |
        VERSION=${{ steps.calver.outputs.version }}

        # Build for multiple Linux architectures
        PLATFORMS=(
          "linux/amd64"
          "linux/arm64"
          "linux/arm"
        )

        mkdir -p dist

        for PLATFORM in "${PLATFORMS[@]}"; do
          GOOS=${PLATFORM%/*}
          GOARCH=${PLATFORM#*/}

          OUTPUT_NAME="puff-${VERSION}-${GOOS}-${GOARCH}"

          echo "Building for ${GOOS}/${GOARCH}..."

          GOOS=$GOOS GOARCH=$GOARCH CGO_ENABLED=0 go build \
            -ldflags "-s -w -X main.version=${VERSION}" \
            -o "dist/${OUTPUT_NAME}" \
            ./cmd/puff

          # Create tarball
          tar -czf "dist/${OUTPUT_NAME}.tar.gz" -C dist "${OUTPUT_NAME}"

          # Generate checksums
          (cd dist && sha256sum "${OUTPUT_NAME}.tar.gz" >> checksums.txt)
        done

        echo "Build complete!"
        ls -lh dist/

    - name: Create Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION=${{ steps.calver.outputs.version }}

        # Create release notes
        cat > release_notes.md << EOF
        # Puff ${VERSION}

        Release built on $(date +%Y-%m-%d)

        ## Installation

        Download the appropriate binary for your system:

        \`\`\`bash
        # For AMD64 (most common)
        curl -L https://github.com/${{ github.repository }}/releases/download/${VERSION}/puff-${VERSION}-linux-amd64.tar.gz | tar xz
        sudo mv puff-${VERSION}-linux-amd64 /usr/local/bin/puff
        sudo chmod +x /usr/local/bin/puff

        # For ARM64
        curl -L https://github.com/${{ github.repository }}/releases/download/${VERSION}/puff-${VERSION}-linux-arm64.tar.gz | tar xz
        sudo mv puff-${VERSION}-linux-arm64 /usr/local/bin/puff
        sudo chmod +x /usr/local/bin/puff

        # For ARM
        curl -L https://github.com/${{ github.repository }}/releases/download/${VERSION}/puff-${VERSION}-linux-arm.tar.gz | tar xz
        sudo mv puff-${VERSION}-linux-arm /usr/local/bin/puff
        sudo chmod +x /usr/local/bin/puff
        \`\`\`

        ## Checksums

        \`\`\`
        $(cat dist/checksums.txt)
        \`\`\`

        ## Changes

        See the commit history for detailed changes.
        EOF

        # Create the release
        gh release create "${VERSION}" \
          --title "Puff ${VERSION}" \
          --notes-file release_notes.md \
          dist/*.tar.gz \
          dist/checksums.txt

    - name: Update latest tag
      if: success()
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -f latest
        git push -f origin latest
